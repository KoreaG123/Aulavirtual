<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Bienvenido | Aula Virtual</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="css/style.css">
</head>
<body>

<div class="dashboard">
  <h1>ğŸ‘‹ Bienvenido al Aula Virtual</h1>

  <p id="welcomeMsg">
    EstÃ¡s usando una cuenta <strong>invitado</strong>.
    Para acceder a los cursos completos debes solicitar acceso.
  </p>

  <div class="card">
    <h3>ğŸ“© Solicitar acceso</h3>
    <p>Un administrador revisarÃ¡ tu solicitud.</p>
    <button id="requestBtn" class="primary-btn">Solicitar acceso</button>
    <p id="statusMsg"></p>
  </div>

  <hr>

  <div class="card locked">
    <h3>ğŸ”’ Cursos Premium</h3>
    <p>Contenido bloqueado hasta que un administrador apruebe tu cuenta.</p>
  </div>

  <br>
  <button id="logoutBtn">Cerrar sesiÃ³n</button>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script src="js/firebase.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const auth = firebase.auth();
  const db = firebase.firestore();

  const requestBtn = document.getElementById("requestBtn");
  const statusMsg = document.getElementById("statusMsg");
  const logoutBtn = document.getElementById("logoutBtn");

  auth.onAuthStateChanged(async user => {
    if (!user) return location.href = "index.html";

    const userDoc = await db.collection("users").doc(user.uid).get();

    if (!userDoc.exists) {
      alert("Usuario no registrado");
      return auth.signOut();
    }

    const role = userDoc.data().role;

    // ğŸ” Si ya es alumno o admin, redirigir
    if (role === "alumno") return location.href = "dashboard.html";
    if (role === "admin") return location.href = "admin.html";

    // Verificar si ya enviÃ³ solicitud
    const req = await db.collection("requests").doc(user.uid).get();
    if (req.exists) {
      requestBtn.disabled = true;
      statusMsg.textContent = "â³ Solicitud enviada. Esperando aprobaciÃ³n.";
    }
  });

  requestBtn.addEventListener("click", async () => {
    const user = auth.currentUser;
    if (!user) return;

    await db.collection("requests").doc(user.uid).set({
      uid: user.uid,
      email: user.email,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      status: "pending"
    });

    requestBtn.disabled = true;
    statusMsg.textContent = "âœ… Solicitud enviada correctamente";
  });

  logoutBtn.onclick = () => {
    auth.signOut().then(() => location.href = "index.html");
  };

});
</script>

</body>
</html>
