<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Aula Virtual | Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <!-- ====== NAVBAR ====== -->
  <header class="navbar">
    <h1>Aula Virtual</h1>
    <button id="logoutBtn">Cerrar sesión</button>
  </header>

  <!-- ====== MAIN CONTENT ====== -->
  <main class="container">
    <div id="content">
      <p style="text-align:center;margin-top:40px;">Verificando sesión...</p>
    </div>
  </main>

  <!-- ====== FOOTER ====== -->
  <footer>
    <p>© 2026 Aula Virtual. Todos los derechos reservados.</p>
  </footer>

  <!-- ====== FIREBASE ====== -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase.js"></script>
  <script src="js/welcome.js"></script>

  <!-- ====== SCRIPT LOCAL ====== -->
  <script>
    const logoutBtn = document.getElementById("logoutBtn");
    const contentDiv = document.getElementById("content");

    logoutBtn.onclick = async () => {
      await firebase.auth().signOut();
      location.href = "index.html";
    };

    firebase.auth().onAuthStateChanged(async user => {
      if (!user) return location.href = "index.html";

      const userDoc = await firebase.firestore().collection("users").doc(user.uid).get();
      if (!userDoc.exists) {
        alert("Usuario no registrado");
        await firebase.auth().signOut();
        return location.href = "index.html";
      }

      const role = userDoc.data().role;
      const db = firebase.firestore();

      // Contenido para invitado (guest)
      if (role === "guest") {
        const req = await db.collection("requests").doc(user.uid).get();
        const requestSent = req.exists;

        contentDiv.innerHTML = `
          <section class="welcome-section">
            <h2>¡Bienvenido a tu aula virtual!</h2>
            <p>Estás usando una cuenta <strong>invitado</strong>. Explora los videos básicos y aprende a tu ritmo.</p>
          </section>

          <section class="videos-section">
            <h3>Videos básicos</h3>
            <div class="video-cards">
              <div class="card">
                <h4>Introducción</h4>
                <video controls src="videos/intro.mp4"></video>
              </div>
              <div class="card">
                <h4>Primeros pasos</h4>
                <video controls src="videos/primeros_pasos.mp4"></video>
              </div>
            </div>
          </section>

          <section class="request-section">
            <button id="requestAccessBtn" class="primary-btn" ${requestSent ? "disabled" : ""}>
              ${requestSent ? "Solicitud enviada" : "Cómo volverte alumno"}
            </button>
            <p id="statusMsg">${requestSent ? "⏳ Solicitud enviada. Esperando aprobación." : ""}</p>
          </section>
        `;

        const requestBtn = document.getElementById("requestAccessBtn");
        const statusMsg = document.getElementById("statusMsg");

        requestBtn.onclick = async () => {
          try {
            const ref = db.collection("requests").doc(user.uid);
            const snap = await ref.get();
            if (snap.exists) {
              alert("⏳ Ya enviaste una solicitud.");
              return;
            }
            await ref.set({
              uid: user.uid,
              email: user.email,
              name: user.displayName || "Usuario",
              status: "pending",
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            requestBtn.disabled = true;
            statusMsg.textContent = "✅ Solicitud enviada. Un administrador la revisará.";
          } catch (err) {
            alert("❌ No se pudo enviar la solicitud");
          }
        };

        return;
      }

      // Contenido para alumno / profesor / admin
      contentDiv.innerHTML = `
        <div class="dashboard">
          <h1>Bienvenido, ${user.displayName || user.email}</h1>
          <p>Tu rol: <strong>${role}</strong></p>

          <div class="stats-section">
            <h2>Métricas Clave</h2>
            <div class="video-cards">
              <div class="card"><h4>Usuarios Activos</h4><p>33</p><p>+22 nuevos este mes</p></div>
              <div class="card"><h4>Cursos</h4><p>96</p><p>Totales</p></div>
              <div class="card"><h4>Profesores</h4><p>12</p><p>Activos</p></div>
            </div>
          </div>

          <div class="quick-access-section">
            <h3>Accesos Rápidos</h3>
            <div class="video-cards">
              ${role === "admin" ? `
              <div class="card"><h4>Gestionar Catálogo</h4><p>Administra archivos y documentos</p></div>` : ""}
              ${role === "profesor" || role === "admin" ? `
              <div class="card"><h4>Planificar Clases</h4><p>Administra planificación de cursos</p></div>` : ""}
              ${role === "admin" ? `
              <div class="card"><h4>Gráficos de Rendimiento</h4><p>Visualiza estadísticas</p></div>` : ""}
            </div>
          </div>
        </div>
      `;
    });
  </script>
</body>
</html>
